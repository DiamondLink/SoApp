<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Liste Tickets</title>
  <!-- Bootstrap CSS -->
  <link href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">



  <!-- Custom CSS -->
  <style>
    .ticket-list-item {
      cursor: pointer;
    }
    .ticket-details {
      display: none;
    }
    .piece-info {
    border: 1px solid black;
    border-radius: 10px;
    padding: 10px;
    margin: 10px;

}

.form-group {
    display: flex;
    justify-content: flex-end;
    gap: 10px;
    align-items: center;
}

.form-label {
    font-weight: 700;
    margin-right: 10px;
}

.input-group {
    display: flex;
    border: 1px solid #ccc;
    border-radius: 5px;
    overflow: hidden;
    width: 150px;
}

.form-input {
    flex: 1;
    border: none;
    padding: 10px;
    outline: none;
    width: 80px;
}

.input-group-text {
    background-color: #eee;
    border: none;
    padding: 10px;
}




  </style>
</head>
<body>
  <nav class="navbar navbar-expand-lg navbar-light bg-light">
		<a class="navbar-brand" href="menu">
			<img width=200 src="static/soa.png" alt="Logo">
		</a>
		<button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
		  <span class="navbar-toggler-icon"></span>
		</button>
		<div class="collapse navbar-collapse" id="navbarNav">
		  <ul class="navbar-nav">
			<li class="nav-item active">
			  <a class="nav-link" href="menu">Menu</a>
			</li>
			<li class="nav-item">
			  <a class="nav-link" href="liste">Liste</a>
			</li>
			<li class="nav-item">
			  <a class="nav-link" href="ticket">Crée un ticket</a>
			</li>
			<li class="nav-item">
				<a class="nav-link" href="user-db" target="_blank" onclick="openInNewTab(event)">Database</a>
			</li>
		  </ul>
		</div>
	  </nav>

  <div class="container">
    
    <ul class="nav nav-tabs">
      <li class="nav-item">
        <a class="nav-link active" href="#" id="all" onclick="changeCategory(this)">Tous les Tickets</a>
      </li>
        {% for categ in category %}
          {% set ns = namespace(numer_of_piece=0) %}
            {% for ticket in tickets %}
              {% if ticket.status != "Terminé" %}
                {% for piece in ticket.pieces %}
                  {% if piece.category_id == categ.id %}
                    {% set ns.numer_of_piece = ns.numer_of_piece + 1 %}
                    {% endif %}
                    {% endfor %}
                  {% endif %}
                {% endfor %}

      <li class="nav-item">
        <a class="nav-link" href="#" style="color: {{categ.color}}; font-weight: bold;" id="{{categ.id}}" onclick="changeCategory(this)">{{categ.category_name}} ({{ns.numer_of_piece}})</a>
      </li>
      {% endfor %}
    </ul>

    <div class="list-group my-4">
      <!-- Un ticket -->
      <div class="list-group-item ticket-list-item">
        {% for ticket in tickets %}
          {% if ticket.status != "Terminé" %}

          {% set ns = namespace(first_piece_color='') %}
    {% for piece in ticket.pieces %}
        {% if loop.first %}
            {% set ns.first_piece_color = piece.category.color %}
        {% endif %}
    {% endfor %}
    {% set ns2 = namespace(nom_employee='g') %}
<div class="card mb-1 ticketItem" style="border-color: {{ns.first_piece_color}};">
  <div class="card-header" id="heading{{ ticket.id }}" data-toggle="collapse" data-target="#collapse{{ ticket.id }}" aria-expanded="false" aria-controls="collapse{{ ticket.id }}" style="cursor: pointer;">
    <h5 class="mb-0">Ticket #{{ ticket.id }}: {% for piece in ticket.pieces %}{% set ns2.nom_employee = piece.ouvert_employee.nom %}<span class="badge" style="background-color: {{ piece.category.color }}; color:white;">{{ piece.libelle }}</span>&nbsp;{% endfor %}<br>{% if ticket.info is not none %}<span class="badge" style="border: 1px solid black; color:black;">{{ ticket.info }}</span>{% endif %}</h5>
    <hr>
    <p class="mb-1" style=""><span style="font-weight: 700;">Téléphone:</span> <span id="phone_{{ ticket.id}}">{{ticket.user.tel}}</span>   
      <button type="button" class="btn btn-outline-dark" onclick="copyToClipboard('phone_{{ ticket.id }}', event)"> <i class="far fa-copy"></i> </button>



      &nbsp;&nbsp;<span style="font-weight: 700;">Statut:</span> <span id="ticketStatus">{{ ticket.status }}</span>   &nbsp;&nbsp;<span style="font-weight: 700;">Date:</span> {{ticket.created_at.strftime("%Y-%m-%d %H:%M") }} &nbsp;&nbsp;  <span style="font-weight: 700;">Crée par</span> {{ns2.nom_employee}}</p>
  </div>

  <div id="collapse{{ ticket.id }}" class="collapse" aria-labelledby="heading{{ ticket.id }}" data-parent="#accordion">
    <div class="card-body">
      <span class="badge" style="color: black; border: 1px solid black; font-size: 1em; font-weight: 400;"> Nom: {{ticket.user.nom}}</span>&nbsp;
      &emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;
      <button type="button" class="btn btn-success" onclick="terminer(this)" id="#{{ticket.id}}">
        Le client a été rapellé
      </button><br>
      {% for piece in ticket.pieces %}
      <hr>
      <span class="badge {{piece.category_id}}" style="color: black; border: 1px solid {{ piece.category.color }}; font-size: 1em;">{{ piece.libelle }}</span>
      <br><br>
      <span class="badge" style="color: black; border: 1px solid black; font-size: 1em; font-weight: 400;"> <strong>Immatriculation:</strong> <span class="immat_{{ piece.id }}">{{piece.immat}}</span></span>&nbsp;
      <span class="badge" style="color: black; border: 1px solid black; font-size: 1em; font-weight: 400;"> <strong>Marque:</strong> <span class="marque_{{ piece.id }}">{{piece.marque}}</span></span>&nbsp;
      <span class="badge" style="color: black; border: 1px solid black; font-size: 1em; font-weight: 400;"> <strong>Modèle:</strong> <span class="modele_{{ piece.id }}">{{piece.modele}}</span></span>&nbsp;
      <span class="badge" style="color: black; border: 1px solid black; font-size: 1em; font-weight: 400;"> <strong>Ref Fabriquant:</strong> <span class="num_{{ piece.id }}">{{piece.numero}}</span></span>&nbsp;
      <span class="badge" style="color: black; border: 1px solid black; font-size: 1em; font-weight: 400;"> <strong>Ref Moteur:</strong> <span class="mot_{{ piece.id }}">{{piece.ref_mot}}</span></span>&nbsp;

      {% if piece.dimension_pneu !="" %}
      <span class="badge" style="color: black; border: 1px solid black; font-size: 1em; font-weight: 400;"> <strong>Dimension Pneu:</strong> <span class="dim_{{ piece.id }}">{{piece.dimension_pneu}}</span></span>&nbsp;
      {% endif %}
      <span class="badge" style="color: black; border: 1px solid black; font-size: 1em; font-weight: 400;"> <strong>Commentaire:</strong> <span class="details_{{ piece.id }}">{{piece.details}}</span></span>&nbsp;

      <button type="button" class="btn btn-warning" onclick="editPiece(this)" id="{{ piece.id }}_{{ ticket.id }}">
        Edit
      </button><br><br>
      
      <div class="row">
        <div class="col">
            {% set etats = ['En attente de traitement', 'Disponible', 'Disponible à démonter', 'Disponible confrère', 'Indisponible'] %}
            <label for="exampleInput">État :</label>
            <select id="etatPiece_{{ piece.id }}_{{ ticket.id }}" class="form-control selectClass">
            {% for etat in etats %}
                {% if piece.etat == etat %}
                    <option selected>{{ etat }}</option>
                {% else %}
                    <option>{{ etat }}</option>
                {% endif %}
            {% endfor %}
            </select>
        </div>
    
        <div class="col">
            <label for="exampleInput">Géré par :</label>
            <select class="form-control" id="employeePiece_{{ piece.id }}_{{ ticket.id }}">
                <option selected disabled value="">Choisir un employé...</option>
                {% for emp in employee %}
                    {% if piece.gere_par == emp.id %}
                        <option value="{{emp.id}}" selected>{{ emp.nom }}</option>
                    {% else %}
                        <option value="{{emp.id}}">{{ emp.nom }}</option>
                    {% endif %}
                {% endfor %}
            </select>
        </div>
    </div>
    <br>

    <div class="addDiv{{ piece.id }}" style="float: left;"></div>

    <div class="form-group">
      <label for="codePostal" class="form-label">Prix :</label>
      <div class="input-group">
          <input type="text" class="form-input" value="{{piece.prix}}" id="prix_{{ piece.id }}">
          <span class="input-group-text">€</span>
      </div>
      <button class="btn btn-success" onclick="savePrice(this)" id="{{ piece.id }}">Enregistrer Prix</button>
  </div>
  
      
      {% endfor %}

    </div>
  </div>
</div>
{% endif %}
{% endfor %}

      <!-- Ajoutez d'autres tickets comme celui-ci -->
    </div>
  </div>

  <!-- Bootstrap JS & jQuery -->
  <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"></script>

<script>

var idleTime = 0;

// Increment the idle time counter every minute.
var idleInterval = setInterval(timerIncrement, 3000); // 1 minute

// Zero the idle timer on mouse movement, key press, or scrolling.
window.addEventListener('mousemove', timerReset);
window.addEventListener('keydown', timerReset);
window.addEventListener('scroll', timerReset);

function timerIncrement() {
    idleTime = idleTime + 1;
    if (idleTime > 9) { // if the user is idle for 10 minutes
        location.reload(); // reload the page
    }
}

function timerReset() {
    idleTime = 0; // reset the idle timer to 0
}



function copyToClipboard(elementId) {
  event.stopPropagation();
        /* Get the text field */
        var copyText = document.getElementById(elementId).innerText.replace(/\./g, '');

        /* Create a temporary textarea for the copy action */
        var tempInput = document.createElement("textarea");
        tempInput.value = copyText;
        document.body.appendChild(tempInput);

        /* Select the text field */
        tempInput.select();
        tempInput.setSelectionRange(0, 99999); /* For mobile devices */

        /* Copy the text inside the text field */
        document.execCommand("copy");

        /* Remove the temporary textarea */
        document.body.removeChild(tempInput);

    
    // Add tooltip to the button and change the title
    $(event.target).attr({
      'data-toggle': 'tooltip',
      'data-placement': 'bottom',
      'title': 'Copied!'
    });

    // Initialize tooltip
    $(event.target).tooltip();

    // Show the tooltip
    $(event.target).tooltip('show');

    // Remove tooltip after 1.5s
    setTimeout(function(){
        $(event.target).tooltip('dispose');
    }, 1500);

    }

function savePrice(btn){
  var id = btn.id.replace(/[^0-9]/g,'');
  var priceElement = document.getElementById(`prix_${id}`)

  var dict = {
    "prix" : priceElement.value
  }


  fetch('/update/Piece/' + id, {
    method: 'POST',
    headers: {
        'Content-Type': 'application/json'
    },
    body: JSON.stringify(dict)
}).then(response => {
    if (!response.ok) {
        throw new Error("HTTP error " + response.status);
    }
})
}

    function update_lp(textVal, id){
  var id = id.replace(/[^0-9]/g,'');

  var dict = {
    "num_ref_lp" : textVal
  }


  fetch('/update/Piece/' + id, {
    method: 'POST',
    headers: {
        'Content-Type': 'application/json'
    },
    body: JSON.stringify(dict)
}).then(response => {
    if (!response.ok) {
        throw new Error("HTTP error " + response.status);
    }
})

}


  $(document).ready(function(){
  $(document).on('input', 'input[id*="dispInput"]', function() {
    update_lp($(this).val(), $(this).attr('id'));
  });
});




function dispChange(selectedEtat, id, time) {
  var parts = id.split('_');
var pieceID = parseInt(parts[1]);




var divToRemove = document.getElementById(`dispDiv${pieceID}`)
if (divToRemove){
  divToRemove.remove();
}
  // Select the div with a specific class
// Replace '.specific-class' with the actual class name you are looking for
var specificDiv = document.querySelector(`.addDiv${pieceID}`);

// Create the outer div
var dispDiv = document.createElement('div');
dispDiv.setAttribute('id', `dispDiv${pieceID}`);

var labelText;
if (selectedEtat == 'Disponible'){
  labelText = 'Ref Piece Opisto :'
} else if (selectedEtat == 'Disponible à démonter'){
  labelText = 'LP :'
} else if (selectedEtat == 'Disponible confrère'){
  labelText = 'N° Pièce :'
} else{
  labelText = 'skip';
}
// Create the label
var dispLabel = document.createElement('label');
dispLabel.setAttribute('id', 'dispLabel');
dispLabel.textContent = labelText;

// Create the input
var dispInput = document.createElement('input');
dispInput.setAttribute('type', 'text');
dispInput.setAttribute('class', 'col-sm-8 form-control');
dispInput.setAttribute('id', `dispInput${pieceID}`);
dispInput.setAttribute('placeholder', '');


if (time=='load'){
  var pieces = JSON.parse('{{ pieces | safe }}');

    var piece = pieces.find(function(p) {
        return p.id === pieceID;
    });

    if (piece) {
        var num_ref_lp = piece.num_ref_lp;
        dispInput.value = num_ref_lp;
    } else {
       console.log("not found")
    }
}

// Append the label and input to the outer div
dispDiv.appendChild(dispLabel);
dispDiv.appendChild(dispInput);

// Append the outer div to the specific div
if (labelText != 'skip'){
specificDiv.appendChild(dispDiv);}
//specificDiv.append(dispLabel)


}


$(document).ready(function() {
    $("select[id*='employeePiece']").change(function() {
        var dict = {
          "gere_par" : $(this).val()
        }
        let id = parseInt($(this).attr('id').split('_')[1], 10);

        fetch('/update/Piece/' + id, {
    method: 'POST',
    headers: {
        'Content-Type': 'application/json'
    },
    body: JSON.stringify(dict)
}).then(response => {
    if (!response.ok) {
        throw new Error("HTTP error " + response.status);
    }
})
    });
});



const regex = /(\d+)_(\d+)/;

function editPiece(btn) {

  var id = btn.id;
  const match = id.match(regex);

  let pieceId = match[1];
let ticketId = match[2];


  var p = btn.parentElement.querySelector(`.immat_${pieceId}`);
  var p2 = btn.parentElement.querySelector(`.marque_${pieceId}`);
  var p3 = btn.parentElement.querySelector(`.modele_${pieceId}`);
  var p4 = btn.parentElement.querySelector(`.num_${pieceId}`);
  var p5 = btn.parentElement.querySelector(`.details_${pieceId}`);
  var p6 = btn.parentElement.querySelector(`.mot_${pieceId}`);

  // Create a new input element
  var input = document.createElement("input");
  var input2 = document.createElement("input");
  var input3 = document.createElement("input");
  var input4 = document.createElement("input");
  var input5 = document.createElement("input");
  var input6 = document.createElement("input");

  input.className = `immat_${pieceId}`;
  input2.className = `marque_${pieceId}`;
  input3.className = `modele_${pieceId}`;
  input4.className = `num_${pieceId}`;
  input5.className = `details_${pieceId}`;
  input6.className = `mot_${pieceId}`;

  
  // Set the value of the input to the content of the paragraph
  input.value = p.textContent;
  input2.value = p2.textContent;
  input3.value = p3.textContent;
  input4.value = p4.textContent;
  input5.value = p5.textContent;
  input6.value = p6.textContent;
  
  // Replace the paragraph with the input
  p.parentNode.replaceChild(input, p);
  p2.parentNode.replaceChild(input2, p2);
  p3.parentNode.replaceChild(input3, p3);
  p4.parentNode.replaceChild(input4, p4);
  p5.parentNode.replaceChild(input5, p5);
  p6.parentNode.replaceChild(input6, p6);


  btn.textContent = "Save";
  btn.className = "btn btn-success";
  btn.onclick = function() {
  savePiece(this);
  }
};






function savePiece(btn) {

  var id = btn.id;
  const match = id.match(regex);

  let pieceId = match[1];
let ticketId = match[2];

  btn.textContent = "Edit";
  btn.className = "btn btn-warning";
  btn.onclick = function() {
  editPiece(this);
  }

  var p = btn.parentElement.querySelector(`.immat_${pieceId}`);
  var p2 = btn.parentElement.querySelector(`.marque_${pieceId}`);
  var p3 = btn.parentElement.querySelector(`.modele_${pieceId}`);
  var p4 = btn.parentElement.querySelector(`.num_${pieceId}`);
  var p5 = btn.parentElement.querySelector(`.details_${pieceId}`);
  var p6 = btn.parentElement.querySelector(`.mot_${pieceId}`);



var dataPiece= {
		"immat" : p.value,
		"marque" : p2.value,
		"modele" : p3.value,
		"numero" : p4.value,
		"details" : p5.value,
    "ref_mot" : p6.value
	}

  var dataTicket = {
    "status" : "En cours"
  }

  var statusText = document.getElementById("ticketStatus");
  statusText.textContent = "En cours"



  var span = document.createElement("span");
  var span2 = document.createElement("span");
  var span3 = document.createElement("span");
  var span4 = document.createElement("span");
  var span5 = document.createElement("span");
  var span6 = document.createElement("span");


  span.className = `immat_${pieceId}`;
  span2.className = `marque_${pieceId}`;
  span3.className = `modele_${pieceId}`;
  span4.className = `num_${pieceId}`;
  span5.className = `details_${pieceId}`;
  span6.className = `mot_${pieceId}`;

  span.textContent = p.value;
  span2.textContent = p2.value;
  span3.textContent = p3.value;
  span4.textContent = p4.value;
  span5.textContent = p5.value;
  span6.textContent = p6.value;

  p.parentNode.replaceChild(span, p);
  p2.parentNode.replaceChild(span2, p2);
  p3.parentNode.replaceChild(span3, p3);
  p4.parentNode.replaceChild(span4, p4);
  p5.parentNode.replaceChild(span5, p5);
  p6.parentNode.replaceChild(span6, p6);



fetch('/update/Piece/' + pieceId, {
    method: 'POST',
    headers: {
        'Content-Type': 'application/json'
    },
    body: JSON.stringify(dataPiece)
}).then(response => {
    if (!response.ok) {
        throw new Error("HTTP error " + response.status);
    }
}).then(() => {; // Notice here
    // Second request
    return fetch('/update/Ticket/' + ticketId, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(dataTicket)
    });
}).then(response => {
    if (!response.ok) {
        throw new Error("HTTP error " + response.status);
    }
}).catch(function() {
    // Handle the error here
});

  }

  window.onload = function() {
    if(!localStorage.getItem("hasCodeRunBefore")) {
        localStorage.setItem("hasCodeRunBefore", true);
        location.reload();
    }
    else {
        localStorage.removeItem("hasCodeRunBefore"); // Remove the flag so the code runs on the next page load
    }
    var selectEtats = document.querySelectorAll('[id*="etatPiece"]');

  selectEtats.forEach(function(selectElement) {
    dispChange(selectElement.value, selectElement.id, "load");
    selectElement.addEventListener("change", function(event) {
      var selectedEtat = event.target.value; // get the selected etat
      // call your function here
      dispChange(selectedEtat, event.target.id, "change");
    });
  });

  var selects = document.getElementsByClassName('selectClass');
  for(var i=0; i<selects.length; i++){
    selects[i].addEventListener("change", function() {

      var id = this.id;
      const match = id.match(regex);


     let dataPiece = {
    "etat" : this.value
};

let dataTicket = {
    "status" : "En cours"
};

var statusText = document.getElementById("ticketStatus");
  statusText.textContent = "En cours"

let pieceId = match[1];
let ticketId = match[2];

// First request
fetch('/update/Piece/' + pieceId, {
    method: 'POST',
    headers: {
        'Content-Type': 'application/json'
    },
    body: JSON.stringify(dataPiece)
}).then(response => {
    if (!response.ok) {
        throw new Error("HTTP error " + response.status);
    }
}).then(() => {; // Notice here
    // Second request
    return fetch('/update/Ticket/' + ticketId, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(dataTicket)
    });
}).then(response => {
    if (!response.ok) {
        throw new Error("HTTP error " + response.status);
    }
}).catch(function() {
    // Handle the error here
});

  });
  }
  }

function terminer(btn){
  var id = btn.id.replace(/[^0-9]/g,'');

  var dict = {
    "status" : "Terminé"
  }

  fetch('/update/Ticket/' + id, {
    method: 'POST',
    headers: {
        'Content-Type': 'application/json'
    },
    body: JSON.stringify(dict)
}).then(response => {
    if (!response.ok) {
        throw new Error("HTTP error " + response.status);
    }
})
  btn.parentNode.parentNode.parentNode.style.display = 'none';

}

function changeCategory(el) {

  var searchString = 'collapse';

// Get all elements whose IDs contain the search string
var elements = document.querySelectorAll('[id*="' + searchString + '"]');


// Set display: none for each matching element
elements.forEach(function(element) {
  element.parentNode.style.display = 'none';
});

  var selectedCategory = el.id;
  
  // If "All" is selected, show all tickets
  if (selectedCategory === "all") {
    showAllTickets();
  }
  else {
    // Otherwise, only show tickets of the selected category
    showTicketsByCategory(selectedCategory);
  }
};


function showAllTickets() {
  var searchString = 'collapse';

// Get all elements whose IDs contain the search string
var elements = document.querySelectorAll('[id*="' + searchString + '"]');


// Set display: none for each matching element
elements.forEach(function(element) {
  element.parentNode.style.display = 'block';
});
}

function showTicketsByCategory(categoryId) {
  var tickets = document.getElementsByClassName(categoryId);

  for (var i = 0; i < tickets.length; i++) {

    var parentElement = tickets[i].parentNode;
    var grandparentElement = parentElement.parentNode;
    parentElement.parentNode.parentNode.style.display = 'block';
}
}






</script>

</body>
</html>
